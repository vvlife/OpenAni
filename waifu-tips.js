/*!
 * Live2D Widget
 * https://github.com/stevenjoezhang/live2d-widget
 */
!function(){"use strict";function e(e){return Array.isArray(e)?e[Math.floor(Math.random()*e.length)]:e}let t;function i(i,o,s){if(!i||sessionStorage.getItem("waifu-text")&&sessionStorage.getItem("waifu-text")>s)return;t&&(clearTimeout(t),t=null),i=e(i),sessionStorage.setItem("waifu-text",s);const a=document.getElementById("waifu-tips");a.innerHTML=i,a.classList.add("waifu-tips-active"),t=setTimeout((()=>{sessionStorage.removeItem("waifu-text"),a.classList.remove("waifu-tips-active")}),o)}class o{constructor(e){let{apiPath:t,cdnPath:i}=e,o=!1;if("string"==typeof i)o=!0,i.endsWith("/")||(i+="/");else{if("string"!=typeof t)throw"Invalid initWidget argument!";t.endsWith("/")||(t+="/")}this.useCDN=o,this.apiPath=t,this.cdnPath=i}async loadModelList(){const e=await fetch(`${this.cdnPath}model_list.json`);this.modelList=await e.json()}async loadModel(t,o,s){if(localStorage.setItem("modelId",t),localStorage.setItem("modelTexturesId",o),i(s,4e3,10),this.useCDN){this.modelList||await this.loadModelList();const i=e(this.modelList.models[t]);loadlive2d("live2d",`${this.cdnPath}model/${i}/index.json`)}else loadlive2d("live2d",`${this.apiPath}get/?id=${t}-${o}`),console.log(`Live2D 模型 ${t}-${o} 加载完成`)}async loadRandModel(){const t=localStorage.getItem("modelId"),o=localStorage.getItem("modelTexturesId");if(this.useCDN){this.modelList||await this.loadModelList();const o=e(this.modelList.models[t]);loadlive2d("live2d",`${this.cdnPath}model/${o}/index.json`),i("我的新衣服好看嘛？",4e3,10)}else fetch(`${this.apiPath}rand_textures/?id=${t}-${o}`).then((e=>e.json())).then((e=>{1!==e.textures.id||1!==o&&0!==o?this.loadModel(t,e.textures.id,"我的新衣服好看嘛？"):i("我还没有其他衣服呢！",4e3,10)}))}async loadOtherModel(){let e=localStorage.getItem("modelId");if(this.useCDN){this.modelList||await this.loadModelList();const t=++e>=this.modelList.models.length?0:e;this.loadModel(t,0,this.modelList.messages[t])}else fetch(`${this.apiPath}switch/?id=${e}`).then((e=>e.json())).then((e=>{this.loadModel(e.model.id,0,e.model.message)}))}}function s(e){const t=document.createElement("video");t.autoplay=!0,t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.objectFit="cover",t.style.zIndex="-1",document.body.prepend(t);const s=new o(e);localStorage.removeItem("waifu-display"),sessionStorage.removeItem("waifu-text"),document.body.insertAdjacentHTML("beforeend",'<div id="waifu">\n            <div id="waifu-tips">按住我說話</div>\n            <canvas id="live2d" width="800" height="800"></canvas>\n            <div id="waifu-tool"></div>\n        </div>\n        <style>\n            #waifu {\n                position: fixed;\n                left: 20px;\n                bottom: 20px;\n                height: 50%;\n                cursor: move;\n                user-select: none;\n                z-index: 1000;\n            }\n\n            #waifu-tips.waifu-tips-active {\n                display: block;\n            }\n        </style>\n        ');let a="";async function n(){return a||new Promise((e=>{"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.get(["savedApiKey"],(t=>{a=t.savedApiKey||"",e(a)})):e("")}))}window.addEventListener("message",(async e=>{"UPDATE_API_KEY"===e.data.type?(a=e.data.apiKey,console.log("API密钥已更新")):"REQUEST_API_KEY"===e.data.type&&(a||(a=await n()),window.postMessage({type:"API_KEY_RESPONSE",apiKey:a},"*"))}));const d=document.getElementById("waifu");let l,c,r,m=!1;d.addEventListener("mousedown",(e=>{e.target===d&&(m=!0,l=e.clientX-d.getBoundingClientRect().left,c=e.clientY-d.getBoundingClientRect().top,d.style.cursor="grabbing")})),document.addEventListener("mousemove",(e=>{m&&(d.style.left=e.clientX-l+"px",d.style.top=e.clientY-c+"px",d.style.bottom="auto")})),document.addEventListener("mouseup",(()=>{m=!1,d.style.cursor="move"})),setTimeout((()=>{const e=document.getElementById("waifu-tips");e.classList.add("waifu-tips-active"),setTimeout((()=>{i("主人可以長按開始對話哦~<br>首次使用請點擊信息圖標設置API密鑰",4e3)}),1e3),e.classList.remove("waifu-tips-active")}),1e3);let u=[],h=[];d.addEventListener("mousedown",(async function(){const e=document.getElementById("waifu-tips");e.innerHTML="正在錄音...",e.classList.add("waifu-tips-active");try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});r=new MediaRecorder(e),r.ondataavailable=e=>{u.push(e.data)},r.start()}catch(t){console.error("錄音錯誤:",t),e.innerHTML="錄音失敗，請重試"}})),d.addEventListener("mouseup",(function(){document.getElementById("waifu-tips").classList.remove("waifu-tips-active"),r&&"inactive"!==r.state&&(r.stop(),r.onstop=async()=>{const e=new Blob(u,{type:"audio/wav"});u=[],localStorage.getItem("siliconflow_api_key");const i=new FormData;i.append("file",e,"recording.wav"),i.append("model","FunAudioLLM/SenseVoiceSmall");let o=document.createElement("canvas"),s=null;if(t.readyState>=t.HAVE_CURRENT_DATA){const e=document.createElement("canvas");e.width=t.videoWidth,e.height=t.videoHeight;e.getContext("2d").drawImage(t,0,0,e.width,e.height),s=e.toDataURL("image/jpeg")}else console.warn("视频元素未准备好，无法捕获图像。");if(s){const e=document.createElement("img");e.src=s,e.style.position="fixed",e.style.right="20px",e.style.bottom="100px",e.style.width="200px",e.style.border="2px solid red",document.body.appendChild(e),setTimeout((()=>e.remove()),5e3)}try{const e=await n(),t=await fetch("https://api.siliconflow.cn/v1/audio/transcriptions",{method:"POST",headers:{Authorization:"Bearer "+e},body:i}),a=await t.json();new Blob(h,{type:"audio/webm"});h=[],r.addEventListener("start",(()=>{o.getContext("2d");const e=document.createElement("video");e.srcObject=stream,e.autoplay=!0,e.muted=!0,e.style.position="fixed",e.style.bottom="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.objectFit="cover";let t=null;requestAnimationFrame((function i(){if(e.readyState>=e.HAVE_CURRENT_DATA){const i=document.createElement("canvas");i.width=e.videoWidth,i.height=e.videoHeight;i.getContext("2d").drawImage(e,0,0,i.width,i.height),t=i.toDataURL("image/jpeg")}else requestAnimationFrame(i)}))}));const d=s?[{type:"image_url",image_url:{url:s}},{type:"text",text:a.text+""}]:[{type:"text",text:a.text+""}],l=await fetch("https://api.siliconflow.cn/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify({model:"THUDM/GLM-4.1V-9B-Thinking",messages:[{role:"user",content:d}],stream:!1})}),c=await l.json();if(!(c.choices&&c.choices[0]&&c.choices[0].message&&c.choices[0].message.content))throw new Error("Invalid API response structure");const m=c.choices[0].message.content,u=document.getElementById("waifu-tips");u.innerHTML=m,u.classList.add("waifu-tips-active");const g=await fetch("https://api.siliconflow.cn/v1/audio/speech",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify({model:"FunAudioLLM/CosyVoice2-0.5B",input:c.choices[0].message.content,voice:"FunAudioLLM/CosyVoice2-0.5B:diana",response_format:"mp3"})}),p=await g.blob(),y=URL.createObjectURL(p);new Audio(y).play()}catch(e){console.error("API调用错误:",e)}})})),setTimeout((()=>{document.getElementById("waifu").style.bottom="20px"}),0),function(){let e=localStorage.getItem("modelId"),t=localStorage.getItem("modelTexturesId");null===e&&(e=1,t=53),s.loadModel(e,t)}()}function a(e,t){"string"==typeof e&&(e={waifuPath:e,apiPath:t}),document.body.insertAdjacentHTML("beforeend",'<div id="waifu-toggle">\n            <span>看板娘</span>\n        </div>');const i=document.getElementById("waifu-toggle");i.addEventListener("click",(()=>{i.classList.remove("waifu-toggle-active"),i.getAttribute("first-time")?(s(e),i.removeAttribute("first-time")):(localStorage.removeItem("waifu-display"),document.getElementById("waifu").style.display="",setTimeout((()=>{document.getElementById("waifu").style.bottom=0}),0))})),localStorage.getItem("waifu-display")&&Date.now()-localStorage.getItem("waifu-display")<=864e5?(i.setAttribute("first-time",!0),setTimeout((()=>{i.classList.add("waifu-toggle-active")}),0)):s(e)}(async()=>{await new Promise((e=>{"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local?chrome.storage.local.get(["savedApiKey"],(t=>{e(t.savedApiKey||"")})):e("")}))&&console.log("工具模块已加载API密钥")})(),window.initWidget=a,a({waifuPath:"waifu-tips.json",cdnPath:"https://fastly.jsdelivr.net/gh/fghrsh/live2d_api/",tools:[]}),chrome.runtime.onMessage.addListener(((e,t,i)=>{if("toggleWaifu"===e.action){const e=document.getElementById("waifu");e?(e.style.display="none"===e.style.display?"block":"none",i({status:e.style.display})):i({status:"not found"})}else"updateApiKey"===e.action&&(console.log("updating api key"),window.postMessage({type:"UPDATE_API_KEY",apiKey:e.apiKey},"*"),i({status:"updated"}))}))}();
